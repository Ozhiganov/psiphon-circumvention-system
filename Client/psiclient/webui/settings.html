<!DOCTYPE html>

<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Psiphon Settings</title>

  <link rel="icon"
      type="image/png"
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjY3NEUwNzYzMUIwQjExRTNBMkVDRERBOUQ5MzI1Nzg1IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjY3NEUwNzY0MUIwQjExRTNBMkVDRERBOUQ5MzI1Nzg1Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6Njc0RTA3NjExQjBCMTFFM0EyRUNEREE5RDkzMjU3ODUiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6Njc0RTA3NjIxQjBCMTFFM0EyRUNEREE5RDkzMjU3ODUiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6DBJ9BAAAPU0lEQVRo3sWabaxlV1nH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">
  <link rel="stylesheet" type="text/css" href="flags16.css">
  <link rel="stylesheet" type="text/css" href="msdropdown.css">
  <style type="text/css">
    /* Old IE's inline-block style is broken, so we'll create a hack-ish class to fix it.
    From: http://uncorkedstudios.com/blog/how-to-fix-the-ie7-and-inlineblock-css-bug */
    .inline-block {
      display: inline-block;
      zoom: 1;
      *display: inline;
    }

    body {
      color: #000000;
      font-size: 11pt;
      font-family: Arial,Helvetica,sans-serif;
      margin: auto;
      padding: 1em;
    }

    .hidden {
      display: none;
    }

    .error-help {
      color: red;
      size: 0.8em;
    }

    .setting-item {
      margin-bottom: 2em;
    }

    .port-entry {
      width: 5em;
    }

    .vpn-incompatible-msg {
      size: 0.8em;
    }

    .disabled-text {
      zoom: 1; filter: alpha(opacity=60); /* IE<=8 */
      opacity: 0.6;
    }

    .perma-disabled {
      zoom: 1; filter: alpha(opacity=60); /* IE<=8 */
      opacity: 0.6;
    }

    .checkbox-description {
      margin-left: 2em;
    }

    .setting-description {
      font-size: 0.8em;
      margin-left: 2em;
    }

    .f16, .f32 {
      height: 20px !important;
    }
    .flag {
      /* Restrict the height so the image file doesn't determine the dropdown size */
      width: 100% !important;
      padding: 0 20px 0 20px !important;
      line-height: normal !important;
      margin: 2px 0 2px 2px !important;
    }
    li.flag {
      border: 0 !important;
    }

    .f16 .flag-unknown{
      background:url(flag_unknown_16.png) no-repeat;
    }

    .btn {
      text-align: center;
      font-family: Arial;
      color: #ffffff;
      font-size: 20px;
      padding: 10px 20px 10px 20px;
      text-decoration: none;
    }
    .btn:hover {
      text-decoration: none;
    }

    .btn-primary {
      background: #3498db;
      background-image: -webkit-linear-gradient(top, #3498db, #2980b9);
      background-image: -moz-linear-gradient(top, #3498db, #2980b9);
      background-image: -ms-linear-gradient(top, #3498db, #2980b9);
      background-image: -o-linear-gradient(top, #3498db, #2980b9);
      background-image: linear-gradient(to bottom, #3498db, #2980b9);
    }
    .btn-primary:hover {
      background: #3cb0fd;
      background-image: -webkit-linear-gradient(top, #3cb0fd, #3498db);
      background-image: -moz-linear-gradient(top, #3cb0fd, #3498db);
      background-image: -ms-linear-gradient(top, #3cb0fd, #3498db);
      background-image: -o-linear-gradient(top, #3cb0fd, #3498db);
      background-image: linear-gradient(to bottom, #3cb0fd, #3498db);
    }

    .btn-secondary {
      background: #0a2f47;
    }
    .btn-secondary:hover {
      background: #fc893c;
      background-image: -webkit-linear-gradient(top, #fc893c, #d93434);
      background-image: -moz-linear-gradient(top, #fc893c, #d93434);
      background-image: -ms-linear-gradient(top, #fc893c, #d93434);
      background-image: -o-linear-gradient(top, #fc893c, #d93434);
      background-image: linear-gradient(to bottom, #fc893c, #d93434);
    }
  </style>

<!--[if lt IE 9]>
<style type="text/css">
body {
    padding: 20px;
    max-width: 700px;
    min-width: 600px;
  }
</style>
<![endif]-->
<!--[if IE]>
<style type="text/css">
html {
  width:720px;
  height:670px;
  }
</style>
<![endif]-->

</head>

<body>
  <h1>Psiphon Settings</h1>

  <div class="setting-item">
    <!-- The inline styles are hacks to keep the text from shifting when the
         fancy combobox opens and closes. -->
    <div style="height:24px">
      <div class="inline-block" style="vertical-align:top;margin-top:0.1em">
        <strong>Select desired Psiphon server region:&nbsp;</strong>
      </div>
      <div class="inline-block">
        <select style="width:15em" id="EgressRegion" data-usesprite="f16" data-roundedcorner=no>
          <option value="" class="flag flag-unknown" selected>Best Performance</option>
          <option value="US" class="flag us">United States</option>
          <option value="GB" class="flag gb">United Kingdom</option>
          <option value="JP" class="flag jp">Japan</option>
          <option value="SG" class="flag sg">Singapore</option>
          <option value="NL" class="flag nl">Netherlands</option>
          <option value="DE" class="flag de">Germany</option>
        </select>
      </div>
    </div>
    <div class="setting-description">
      Psiphon has servers in many different countries. For the fastest connection
      speed you should choose "Best Performance", but you may instead prefer to
      use a server in a specific country.
    </div>
  </div>

  <div class="setting-item">
    <input type="checkbox" id="VPN"/>
    <label for="VPN">
        <strong>Use VPN Mode</strong>
    </label>
    <div class="checkbox-description setting-description">
      Uses Windows IPSec/L2TP VPN. This mode will tunnel all your apps, but it
      doesn't provide obfuscation. It is not recommended unless VPN-like behavior is required.
    </div>
  </div>

  <div class="setting-item">
    <fieldset>
    <legend><strong>Local Proxy Ports</strong></legend>
      <div class="setting-description">
        Leave blank for automatic port selection (recommended).
      </div>
      <table>
        <tr>
          <td style="text-align:right;">HTTP/HTTPS:</td>
          <td><input type="text" id="LocalHttpProxyPort" class="port-entry"/></td>
          <td>
            <span class="error-help hidden LocalHttpProxyPort">
              Must be a number between 1 and 65535.
            </span>
          </td>
        </tr>
        <tr class="vpn-incompatible">
          <td style="text-align:right;" class="vpn-incompatible">SOCKS:</td>
          <td><input type="text" id="LocalSocksProxyPort" class="port-entry vpn-incompatible"/></td>
          <td class="vpn-incompatible">
            <span class="error-help hidden LocalSocksProxyPort">
              Must be a number between 1 and 65535.
            </span>
            <span class="vpn-incompatible-msg">(Doesn't work with VPN mode.)</span>
          </td>
        </tr>
      </table>
    </fieldset>
  </div>

  <div class="setting-item">
    <fieldset class="vpn-incompatible">
    <legend><strong>Upstream Proxy</strong> <span class="vpn-incompatible-msg">(Doesn't work with VPN mode.)</span></legend>
      <div class="setting-description">
        If your computer already has a proxy configured, by default Psiphon will
        use that proxy when establishing a tunnel. You can override that by specifying
        a proxy to use, or by specifying that no such "upstream proxy" should be used.<br>
        Only HTTP proxies that support HTTPS are allowed.
      </div>
      <table>
        <tr class="skip-upstream-proxy-incompatible">
          <td style="text-align:right;"><span>Hostname:</span></td>
          <td><input type="text" id="UpstreamProxyHostname"/></td>
          <td></td>
        </tr>
        <tr class="skip-upstream-proxy-incompatible">
          <td style="text-align:right;">Port:</td>
          <td><input type="text" id="UpstreamProxyPort" class="port-entry"/></td>
          <td>
            <span class="error-help hidden UpstreamProxyPort">
              Must be a number between 1 and 65535.
            </span>
          </td>
        </tr>
        <tr>
          <td style="text-align:right;">
            <input type="checkbox" id="SkipUpstreamProxy"/>
          </td>
          <td>
            <label for="SkipUpstreamProxy">
              Don't use upstream proxy
            </label>
          </td>
          <td></td>
        </tr>
      </table>
    </fieldset>
  </div>

  <div class="setting-item vpn-incompatible perma-disabled">
    <input type="checkbox" id="SplitTunnel" disabled/>
    <label for="SplitTunnel">
      <strong>Don't proxy domestic websites (Not yet supported!)</strong>
      <span class="vpn-incompatible-msg">(Doesn't work with VPN mode.)</span>
    </label>
    <div class="checkbox-description setting-description">
      If enabled, requests made to servers within your home country will not be
      tunneled through Psiphon.
    </div>
  </div>

  <div>
    <a id="OK" class="submit btn btn-primary inline-block" href="#">OK</a>
    <a id="Reset" class="submit btn btn-secondary inline-block" href="#">Reset</a>
    <a id="Cancel" class="submit btn btn-secondary inline-block" href="#">Cancel</a>
  </div>

<script src="jquery.js"></script>
<script src="msdropdown.js"></script>
<script src="json.js"></script>

<script>
// We need to set up the window.onerror handler in a separate script block, otherwise
// compilation errors in the main code might prevent the handler from getting set.
/*window.onerror = function(errorMsg, url, lineNumber) {
  alert("Window caught error on line " + lineNumber + ": " + errorMsg + "\nPlease report this error.");
};*/

function exceptionString(ex) {
  return ex.name + ': ' + ex.description;
}
</script>

<script>
$(function() {
  // This is assignment is merely to help with testing
  if (!window.dialogArguments) window.dialogArguments = '{ "SplitTunnel": 1, "VPN": 0, "LocalHttpProxyPort": 7771, "LocalSocksProxyPort": 7770, "SkipUpstreamProxy": 1, "UpstreamProxyHostname": "", "UpstreamProxyPort": 234, "EgressRegion": "GB", "defaults": { "SplitTunnel": 0, "VPN": 0, "LocalHttpProxyPort": "", "LocalSocksProxyPort": "", "SkipUpstreamProxy": 0, "UpstreamProxyHostname": "", "UpstreamProxyPort": "", "EgressRegion": ""  } }';

  var args = JSON.parse(window.dialogArguments);

  fillSettingsValues(args);

  // Check for valid input in port number fields
  $('.port-entry').keyup(checkPortField);

  $('#OK').click(onOK);
  $('#Cancel').click(onCancel);
  $('#Reset').click(function(event) { onReset(event, args.defaults); });
  // Treat the ESC key like Cancel
  $(document).keydown(function(e) {
      // ESCAPE key pressed
      if (e.keyCode === 27) {
          onCancel(e);
      }
  });
  // Make all submit buttons equal width.
  var maxWidth = 0;
  $('.submit.btn').each(function() {
    maxWidth = Math.max($(this).width(), maxWidth);
  });
  $('.submit.btn').width(maxWidth);

  // This must come after the values of any select elements have been changed,
  // or else the dropdown will need to be refreshed.
  $('body select').msDropDown();
});

function whatisdate() {
  return '' + Date.now();
}

function fillSettingsValues(obj) {
  if (typeof(obj.SplitTunnel) !== 'undefined') {
    $('#SplitTunnel').prop('checked', obj.SplitTunnel);
  }

  if (typeof(obj.VPN) !== 'undefined') {
    $('#VPN').prop('checked', obj.VPN);
  }
  $('#VPN').change(vpnModeUpdate);
  vpnModeUpdate();

  if (typeof(obj.LocalHttpProxyPort) !== 'undefined') {
    $('#LocalHttpProxyPort').val(obj.LocalHttpProxyPort > 0 ? obj.LocalHttpProxyPort : "");
  }
  $('#LocalHttpProxyPort').trigger('keyup');

  if (typeof(obj.LocalSocksProxyPort) !== 'undefined') {
    $('#LocalSocksProxyPort').val(obj.LocalSocksProxyPort > 0 ? obj.LocalSocksProxyPort : "");
  }
  $('#LocalSocksProxyPort').trigger('keyup');

  if (typeof(obj.UpstreamProxyHostname) !== 'undefined') {
    $('#UpstreamProxyHostname').val(obj.UpstreamProxyHostname);
  }

  if (typeof(obj.UpstreamProxyPort) !== 'undefined') {
    $('#UpstreamProxyPort').val(obj.UpstreamProxyPort > 0 ? obj.UpstreamProxyPort : "");
  }
  $('#UpstreamProxyPort').trigger('keyup');

  if (typeof(obj.SkipUpstreamProxy) !== 'undefined') {
    $('#SkipUpstreamProxy').prop('checked', obj.SkipUpstreamProxy);
  }
  $('#SkipUpstreamProxy').change(skipUpstreamProxyUpdate);
  skipUpstreamProxyUpdate();

  if (typeof(obj.EgressRegion) !== 'undefined') {
    $('#EgressRegion').val(obj.EgressRegion);
  }
  $('body select').each(function(){if (this.refresh) this.refresh()});
}

function onOK(event) {
  event.preventDefault();

  var valid = true;

  $('.port-entry').each(function() {
    if (validatePort($(this).val()) === false) {
      $('.error-help.'+this.id).removeClass('hidden');
      $(this).focus();
      valid = false;
      return;
    }
  });

  if (!valid) {
    return;
  }

  var returnValue = {
    VPN: $('#VPN').prop('checked') ? 1 : 0,
    SplitTunnel: $('#SplitTunnel').prop('checked') ? 1 : 0,
    LocalHttpProxyPort: validatePort($('#LocalHttpProxyPort').val()),
    LocalSocksProxyPort: validatePort($('#LocalSocksProxyPort').val()),
    UpstreamProxyHostname: $('#UpstreamProxyHostname').val(),
    UpstreamProxyPort: validatePort($('#UpstreamProxyPort').val()),
    SkipUpstreamProxy: $('#SkipUpstreamProxy').prop('checked') ? 1 : 0,
    EgressRegion: $('#EgressRegion').val()
  };
  window.returnValue = JSON.stringify(returnValue);
  window.close();
  return false;
}

function onCancel(event) {
  event.preventDefault();
  // Don't set window.returnValue
  window.close();
  return false;
}

function onReset(event, obj) {
  event.preventDefault();
  fillSettingsValues(obj);
  return false;
}

// Returns the numeric port if valid, otherwise false
function validatePort(val) {
  if (val.length === 0) {
    return 0;
  }

  val = parseInt(val);
  if (isNaN(val) || val < 1 || val > 65535) {
    return false;
  }

  return val;
}

function checkPortField(event) {
  var val = $(event.target).val();
  if (validatePort(val) === false) {
    $('.error-help.'+event.target.id).removeClass('hidden');
  }
  else {
    $('.error-help.'+event.target.id).addClass('hidden');
  }
}

// Some of the settings are incompatible with VPN mode. We'll modify the display
// depending on the choice of VPN mode.
function vpnModeUpdate() {
  var vpn = $('#VPN').prop('checked');
  $('input.vpn-incompatible:not(.perma-disabled), .vpn-incompatible:not(.perma-disabled) input').prop('disabled', vpn);
  $('.vpn-incompatible-msg').toggleClass('hidden', !vpn);
  $('.vpn-incompatible').toggleClass('disabled-text', vpn);
}

// The other upstream proxy settings should be disabled if skip-upstream-proxy is set.
function skipUpstreamProxyUpdate() {
  var skipUpstreamProxy = $('#SkipUpstreamProxy').prop('checked');
  $('.skip-upstream-proxy-incompatible input').prop('disabled', skipUpstreamProxy);
  $('.skip-upstream-proxy-incompatible').toggleClass('disabled-text', skipUpstreamProxy);
}
</script>

</body>

</html>

